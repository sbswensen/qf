{{define "title"}} New {{.DocumentStructure}} Document {{end}}


{{define "styles"}}
  <style>
  label {
    display: block;
  }
  form div {
    margin-bottom: 10px;
  }
  input, select, textarea {
    width: 300px;
  }
  input[type=submit], input[type=checkbox] {
    width:auto;
  }
  #help-text-box {
    margin-bottom: 10px;
  }
  h4 {
    margin-top: 5px;
    margin-bottom: 5px;
  }
  table input, table select, table textarea {
    width: 200px;
  }
  table thead {
    font-weight: bold;
  }
  </style>
{{end}}


{{define "main"}}
  <h3>New {{.DocumentStructure}} Document</h3>
  {{if ne .HelpText ""}}
    <h4>Help Text</h4>
    <div id="help-text-box">
      {{call .UndoEscape .HelpText}}
    </div>
  {{end}}
  <form method="post" action="">
    {{range .DDs}}
      <div>
        {{ if eq .Type "Section Break"}}
          <h4>{{.Label}}</h4>
        {{ else }}
          <label>{{.Label}}</label>
        {{ end }}

        {{ if eq .Type "Check"}}
          <input type="checkbox" name="{{.Name}}">

        {{else if eq .Type "Data"}}
          {{ if .Required}}
            <input type="text" name="{{.Name}}" required>
          {{ else }}
            <input type="text" name="{{.Name}}">
          {{ end }}

        {{else if eq .Type "Date"}}
          {{ if .Required }}
            <input type="date" name="{{.Name}}" required>
          {{ else }}
            <input type="date" name="{{.Name}}">
          {{end}}

        {{ else if eq .Type "Datetime"}}
          {{ if .Required }}
            <input type="datetime-local" name={{.Name}} required>
          {{else}}
            <input type="datetime-local" name="{{.Name}}">
          {{end}}

        {{else if eq .Type "Email"}}
          {{if .Required}}
            <input type="email" name="{{.Name}}" required>
          {{else}}
            <input type="email" name="{{.Name}}">
          {{end}}

        {{else if eq .Type "Float"}}
          {{if .Required}}
            <input type="number" step="0.0000001" name="{{.Name}}" required>
          {{else}}
            <input type="number" step="0.0000001" name="{{.Name}}">
          {{end}}

        {{else if or (eq .Type "Int") (eq .Type "Link")}}
          {{if .Required}}
            <input type="number" name="{{.Name}}" required>
          {{else}}
            <input type="number" name="{{.Name}}">
          {{end}}

        {{ else if eq .Type "Read Only"}}
          <input type="text" name="{{.Name}}" disabled>

        {{ else if eq .Type "Select"}}
          <select name="{{.Name}}">
            {{range .OtherOptions}}
              <option>{{.}}</option>
            {{end}}
          </select>

        {{else if eq .Type "Table"}}
          {{$childTable := index .OtherOptions 0}}
          {{$docData := index $.TableFields $childTable}}
          <input type="hidden" name="rows-count-for-{{.Name}}" value="1" />
          <table id="{{.Name}}">
            <thead>
              <tr>
                <td>No</td>
                {{range $docData}}
                  <td>{{.Label}}</td>
                {{end}}
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>1</td>
                {{range $docData}}
                  <td>
                    {{ if eq .Type "Check"}}
                      <input type="checkbox" name="{{.Name}}-1">

                    {{else if eq .Type "Data"}}
                      {{ if .Required}}
                        <input type="text" name="{{.Name}}-1" required>
                      {{ else }}
                        <input type="text" name="{{.Name}}-1">
                      {{ end }}

                    {{else if eq .Type "Date"}}
                      {{ if .Required }}
                        <input type="date" name="{{.Name}}-1" required>
                      {{ else }}
                        <input type="date" name="{{.Name}}-1">
                      {{end}}

                    {{ else if eq .Type "Datetime"}}
                      {{ if .Required }}
                        <input type="datetime-local" name="{{.Name}}-1" required>
                      {{else}}
                        <input type="datetime-local" name="{{.Name}}-1">
                      {{end}}

                    {{else if eq .Type "Email"}}
                      {{if .Required}}
                        <input type="email" name="{{.Name}}-1" required>
                      {{else}}
                        <input type="email" name="{{.Name}}-1">
                      {{end}}

                    {{else if eq .Type "Float"}}
                      {{if .Required}}
                        <input type="number" step="0.0000001" name="{{.Name}}-1" required>
                      {{else}}
                        <input type="number" step="0.0000001" name="{{.Name}}-1">
                      {{end}}

                    {{else if or (eq .Type "Int") (eq .Type "Link")}}
                      {{if .Required}}
                        <input type="number" name="{{.Name}}-1" required>
                      {{else}}
                        <input type="number" name="{{.Name}}-1">
                      {{end}}

                    {{ else if eq .Type "Read Only"}}
                      <input type="text" name="{{.Name}}-1" disabled>

                    {{ else if eq .Type "Select"}}
                      <select name="{{.Name}}-1">
                        {{range .OtherOptions}}
                          <option>{{.}}</option>
                        {{end}}
                      </select>

                    {{else if eq .Type "Text"}}
                      {{if .Required}}
                        <textarea name="{{.Name}}-1" required></textarea>
                      {{else}}
                        <textarea name="{{.Name}}-1"></textarea>
                      {{end}}

                    {{else if eq .Type "URL"}}
                      {{if .Required}}
                        <input type="url" name="{{.Name}}-1" required>
                      {{else}}
                        <input type="url" name="{{.Name}}-1">
                      {{end}}

                    {{end}}
                  </td>
                {{end}}
                <td>
                  <button type="button" id="delete-row-1" class="delete-row-btn">Delete</button>
                </td>
              </tr>
            </tbody>
          </table>
          <button type="button" class="add-row">Add Row</button>
        {{else if eq .Type "Text"}}
          {{if .Required}}
            <textarea name="{{.Name}}" required></textarea>
          {{else}}
            <textarea name="{{.Name}}"></textarea>
          {{end}}

        {{else if eq .Type "URL"}}
          {{if .Required}}
            <input type="url" name="{{.Name}}" required>
          {{else}}
            <input type="url" name="{{.Name}}">
          {{end}}

        {{end}}
      </div>
    {{end}}

    <div>
      <input type="submit" value="Create" >
    </div>
  </form>

{{end}}


{{define "scripts"}}
  <script>
  function deleteRowHandler(e) {
    e.preventDefault();

    var parentTable = $(e.target).parents('table');
    $(e.target).parents('tr').remove();
    setRowsCount(parentTable);

    // reset the numbers
    $('tbody tr', parentTable).each(function(i, el) {
      var newNo = i + 1;
      var strNewNo = newNo.toString()
      $('td:first', el).text(strNewNo);
      $('.delete-row-btn', el).attr('id', 'delete-row-' + strNewNo);

      $('input, textarea, select', el).each(function(ii, elel) {
        var elelname = $(elel).attr('name');
        for (var j = 2; j < 4; j++) {
          if (elelname[elelname.length-j] == "-") {
            var newName = elelname.substr(0, elelname.length-j) + "-" + strNewNo;
            $(elel).attr("name", newName);
            break
          }
        }
      });

    });
  }


  function setRowsCount(table) {
    var tid = $(table).attr('id');
    $('input[name=rows-count-for-' + tid + ']').val( $('tbody tr', table).length );
  }

  $(document).ready(function() {
    $('#delete-row-1').hide();

    $('.add-row').click(function(e) {
      var table = $(e.target).prev();
      var currentNo = parseInt($('tr:last td:first', table).text());
      var newNo = currentNo + 1;
      var html = $('tr:last', table).html();
      var re = new RegExp(currentNo.toString(), 'g');
      html = html.replace(re, newNo.toString());

      html = "<tr>" + html + "</tr>";
      $('tbody', table).append(html);

      $('#delete-row-' + newNo.toString()).click(deleteRowHandler);
      $('#delete-row-' + newNo.toString()).show();

      $('html, body').scrollTop($(document).height());
      setRowsCount(table);
    });
  });
  </script>
{{end}}
